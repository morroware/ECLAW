# MediaMTX configuration for Remote Claw — USB Camera
# Copy to /etc/mediamtx.yml on the Pi 5 (or any Linux host with a USB camera)
#
# This config uses ffmpeg to capture from a V4L2 USB camera device
# and publish the stream into MediaMTX via RTSP.
#
# Requirements:
#   - ffmpeg installed (apt install ffmpeg)
#   - USB camera connected (check: ls /dev/video*)

logLevel: warn

rtsp: yes
rtspAddress: 127.0.0.1:8554

webrtc: yes
webrtcAddress: 127.0.0.1:8889

# Low-latency HLS — fallback for iOS Safari when WebRTC UDP is
# unreachable (restrictive networks, missing port-forward, etc.).
# All iPhone browsers support native HLS and it works over HTTPS/TCP.
hls: yes
hlsAddress: 127.0.0.1:8888
hlsVariant: lowLatency

# ICE connectivity for internet access through a reverse proxy.
#
# webrtcAdditionalHosts tells MediaMTX to include the public IP/domain
# in ICE host candidates so remote browsers can reach the WebRTC UDP
# endpoint.  Without this, ICE candidates only contain 127.0.0.1 and
# LAN IPs which are unreachable from the internet → black video.
#
# Set this to your public domain or IP address:
webrtcAdditionalHosts:
  - claw.thecastlefuncenter.com

# Pin all WebRTC UDP traffic to a single port instead of random
# ephemeral ports.  This allows a single port-forward rule on your
# router (UDP 8189 → Pi LAN IP) instead of requiring a full-cone NAT.
webrtcICEUDPMuxAddress: :8189

webrtcICEServers2:
  - url: stun:stun.l.google.com:19302
  - url: stun:stun1.l.google.com:19302

paths:
  cam:
    # ffmpeg captures from the USB camera and publishes to this path via RTSP.
    # MediaMTX variables: $RTSP_PORT and $MTX_PATH are provided automatically.
    runOnInit: >-
      ffmpeg -f v4l2
      -input_format mjpeg
      -video_size 1280x720
      -framerate 30
      -i /dev/video0
      -c:v libx264
      -profile:v baseline
      -level:v 3.1
      -pix_fmt yuv420p
      -preset ultrafast
      -tune zerolatency
      -b:v 2000k
      -g 30
      -f rtsp
      rtsp://localhost:$RTSP_PORT/$MTX_PATH
    runOnInitRestart: yes
    sourceOnDemand: false

    # To use a different USB camera device, change /dev/video0 above.
    # List available devices with: v4l2-ctl --list-devices
    # List supported formats with: v4l2-ctl -d /dev/video0 --list-formats-ext
    #
    # If your camera doesn't support MJPEG, change -input_format to:
    #   -input_format yuyv422
    # (this may limit resolution/framerate)
